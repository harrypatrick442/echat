<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="x-apple-disable-message-reformatting" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="color-scheme" content="light dark" />
    <meta name="supported-color-schemes" content="light dark" />
    <title></title>
  </head>
  <body>
    <style type="text/css" rel="stylesheet" media="all">
		html{
			height:100%;
		}
		body{
			font-family:monospace;
			background-color:#121112;
			color:white;
			display:flex;
			flex-direction:column;
			margin: 0;
			min-height:100%;
			height:100%;
		}
		.wrapper{
			background-color: #1D1E20;
			padding:10px;
			display:flex;
			flex-direction:column;
			margin:auto;
			width:300px;
			max-width:300px;
			margin-top:20px;
			margin-bottom:20px;
			border-radius:3px;
		}
		preheader{
			
		}
		button{
			margin-top: 10px;
            display:block;
            color:#86B9B0;
			border:2px solid #7b8fa1;
			border-radius: 3px;
			background-color: transparent;
			padding:4px;
			margin-left:auto;
			margin-right:auto;
			cursor:pointer;
        }
		.spinner{
			margin-left:auto;
			margin-right:auto;
		}
		input[type="password"]{
			box-sizing:border-box;
			width: 96%;
			border: 2px solid #7b8fa1;
			background-color: transparent;
			border-radius: 3px;
			padding: 4px;
			height: 20px;
			margin-top: 10px;
			outline: none;
			width: 100%;
			height:24px;
		}
		
		input[type="password"].has-error{
			border-color:#F45A6C;
		}
		#error{
			display:none;
			margin-top:10px;
			color:#F45A6C;
			width:100%;
		}
		#error.has-error{
			display:block;
		}
		.masthead,
		.footer{
			margin-left:auto;
			margin-right:auto;
			text-align:center;
			color: #A8AAAF;
		}
		.footer{
			margin-top:auto;
			margin-bottom:10px;
		}
		.masthead{
			margin-top:10px;
			margin-bottom:auto;
		}
		.reset-successfully-message{
			display:none;
			color:#86B9B0;
			font-weight:bold;
			text-align:center;
		}
		.reset-successfully .reset-successfully-message{
			display:block;
		}
		.reset-successfully input[type="password"],
		.reset-successfully #update-button,
		.reset-successfully #preheader{
			display:none;
		}
	</style>
	
	<a class="masthead" href="https://e-chat.live" class="f-fallback email-masthead_name">
	E-Chat
	</a>
	<div class="wrapper">
		<span id="preheader">Enter your new EChat password...</span>
		<input type="password" id="password" placeholder="Password"/>
		<input type="password" id="confirm-password" placeholder="Confirm password"/>
		<span id="error"></span>
		<span class="reset-successfully-message">Reset password successfully!</span>
		<button id="update-button">Update</button>
	</div>
	  <p class="footer">
		One Stone Solutions LTD
		<br>Newminster House 27-29 Baldwin Street,
		<br>Bristol,
		<br>England,
		<br>BS1 1LT2
	  </p>
    <script type="text/javascript">
		const url  = "{{url}}";
		const secret = "{{secret}}";
		const passwordMinLength = '{{passwordMinLength}}';
		const passwordMaxLength = '{{passwordMaxLength}}';
		const passwordElement = document.getElementById('password');
		const confirmPasswordElement = document.getElementById('confirm-password');
		const errorElement = document.getElementById('error');
		const updateButton = document.getElementById('update-button');
		const isTooShort = (p)=>(p===null)||(p===undefined)||(p.length<passwordMinLength);
		const isTooLong = (p)=>(p!==null)&&(p!==undefined)&&(p.length>passwordMaxLength);
		const setHasError = (element, value)=>{
			if(value)
				element.classList.add('has-error');
			else
				element.classList.remove('has-error');
		};
		const theLengthSentence = `The length must be between ${passwordMinLength} and ${passwordMaxLength} characters!`;
		updateButton.addEventListener('click', ()=>{
			const password = passwordElement.value;
			const confirmPassword = confirmPasswordElement.value;
			console.log(password);
			console.log(confirmPassword);
			let error;
			let passwordError = false, confirmPasswordError = false;
			console.log(passwordMinLength);
			console.log(passwordMaxLength);
			if(isTooShort(password)){
			console.log('too short');
				passwordError = true;
				lengthErrors = true;
				error = `Password is too short. ${theLengthSentence}`;
			}
			else
			if(isTooLong(password)){
				passwordError = true;
				lengthErrors = true;
				error = `Password is too long. ${theLengthSentence}`;
			}
			else
			if(password!==confirmPassword){
				confirmPasswordError = true;
				error = 'passwords do not match';
			}
			
			setHasError(passwordElement, passwordError);
			setHasError(confirmPasswordElement, confirmPasswordError);
			if(error){
				errorElement.innerHTML = error;
			}
			else{
				errorElement.innerHTML = '';
			}
			setHasError(errorElement, error);
			if(error)return;
			const xhr = new XMLHttpRequest();
			xhr.open("POST", url, true);
			xhr.setRequestHeader("Content-Type", "application/json");
			xhr.onreadystatechange = () => {
			  if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
				var response = JSON.parse(xhr.responseText);
				const {success}=response;
				if(success){
					document.body.classList.add('reset-successfully');
				}
			  }
			};
			xhr.send(JSON.stringify({
				secret,
				password
			}));
		});
	</script>
  </body>
</html>